---
title: Introduction to Harness GitOps PR pipelines
description: Modify an application in just one of its target environments.
sidebar_position: 1
---

:::note

Currently, this feature is behind the feature flags `NG_SVC_ENV_REDESIGN` and `OPTIMIZED_GIT_FETCH_FILES`. Contact [Harness Support](mailto:support@harness.io) to enable the feature.

:::

This topic introduces you to Harness PR pipelines, which provides a first-class support for modifying existing GitOps Applications, especially for those that are generated by ApplicationSets using the [Git Generator](https://argocd-applicationset.readthedocs.io/en/stable/Generators-Git/).

Often, even though your ApplicationSet syncs one microservice/application to multiple target environments, you might want to change a microservice in just one of the target environments, such as a dev environment. A Harness PR Pipeline enables you to do this.

:::tip Important

This topic builds on the ApplicationSet concept discussed in [Harness GitOps ApplicationSets](/docs/continuous-delivery/gitops/applicationsets/harness-git-ops-application-set-tutorial.md). It is recommended that you go through that topic before venturing into this one.

:::

## Basics

A typical GitOps Application syncs a source manifest to a destination cluster. If you have multiple target clusters, you could create separate GitOps Applications for each one, but that makes management more challenging. Also, what if you want to sync an application with 100s of target clusters? Managing 100s of GitOps Applications is not acceptable.

To solve this use case, Harness supports ApplicationSets.

### ApplicationSets: A Quick Recap

An ApplicationSet can be thought of as a kind of Application factory. It defines one application template and syncs it to multiple target environments. It is similar to an Application but uses a template to achieve application automation with multiple target environments.

You can add an ApplicationSet manifest to a Harness GitOps Application just like you would add a typical Deployment manifest. At runtime, Harness uses the ApplicationSet to deploy the applications generated by the common template to all the target environments' clusters.

![](static/harness-git-ops-application-set-tutorial-61.png)

ApplicationSets use generators to generate parameters that are substituted into the `template:` section of the ApplicationSet resource during template rendering.

There are many types of generators, however, Harness provides first-class support for the **Git Generator** with the **Update Release Repo** and **Merge PR** steps in the PR pipeline. 

For more information on other Generators, please refer to [Generators](https://argocd-applicationset.readthedocs.io/en/stable/Generators/) from Argo CD docs. 

### Git Generator

At its core, ArgoCD's Git generator allows for dynamic creation of ArgoCD Application resources from templates using parameters sourced from a Git repository. This enables applications to be defined once in a template and instantiated multiple times with different configurations. The key aspect lies in its ability to pull environment-specific or application-specific configurations directly from a Git repository, ensuring version control and traceability. 

While the Git generator supports various methods, one of its standout features is the file-oriented approach, specifically using `config.json` files. 

#### Benefits of using a Git Generator

- **Arbitrary Key Updates**: With the file version of the Git generator, users can define key-value pairs in `config.json` that directly overrides or supplements values in the target application's configuration. This provides unparalleled flexibility in updating configurations on-the-fly without altering the core template. 
- **Decoupling Configuration from Template**: By using a separate `config.json` for overrides, the core application template remains untouched. This separation ensures that base configurations are consistent, reducing errors and ensuring that changes are traceable to specific configuration files.
- **Version Control and Auditability**: Since configurations are stored in Git, every change to `config.json` is versioned. This provides a clear audit trail, making it easy to track when a configuration change was made and by whom.
- **Dynamic Application Generation**: The Git generator, especially with `config.json` files, allows for the dynamic creation of applications based on varying configurations. For instance, one could have a base template for a microservice but instantiate it differently for development, staging, and production environments using different `config.json` files.
- **Centralized Management**: Storing all `config.json` files in a single Git repository or organized structure ensures centralized management. Teams can collaboratively update configurations, propose changes through pull requests, and review configurations collectively.

### Harness PR Pipelines

Harness PR Pipelines allow you to manage the configuration of individual applications created by the ApplicationSet. The key differentiator between various config files for the ApplicationSet is generally chosen to be the folder structure, which would usually align with the environment name in Harness.

When you deploy a Harness PR Pipeline, you simply indicate what target environment application you want to update and the config.json keys/values you want changed, such as release tags. Harness creates the pull request in your Git repo and merges it for you. Now, the target environment application has the new keys/values, which can then be reviewed and deployed by syncing the ApplicationSet.

![](static/harness-git-ops-application-set-tutorial-62.png)

<details>
<summary>An aside: Wave deployments</summary>

You often hear the term wave deployments used when PR Pipelines are discussed.

A wave deployment is a deployment strategy in Continuous Delivery that involves releasing changes to a portion of users at a time, rather than all users at once. Typically, this is done using separate cloud regions for each target environment.

Wave deployments help reduce the risk of deployment failures and allow for quick recovery. The changes are rolled out in waves, typically starting with a group of users in one region and gradually expanding to the entire user base across all regions. This approach allows for a more controlled and monitored rollout of changes, improving the overall quality and stability of the deployment process.

With Harness GitOps, you can implement wave deployments by creating multiple environments for your application: one environment for each cloud region. Then, gradually promote changes from one environment to the next. This way, you can test changes in a safe and controlled manner before releasing them to the entire user base.

PR Pipelines support the wave deployments practice by allowing you to change a microservice in each target environment as needed.
</details>


## Tutorial

:::note

This tutorial builds on the ApplicationSet created in [Harness GitOps ApplicationSets](/docs/continuous-delivery/gitops/applicationsets/harness-git-ops-application-set-tutorial.md). Please ensure you create an ApplicationSet before proceeding further.

:::

### Create a Harness PR pipeline

Continuing on the ApplicationSet setup from the above-mentioned document, the path to your two `config.json` files would be the following- 

- `examples/git-generator-files-discovery/cluster-config/engineering/dev/config.json`
- `examples/git-generator-files-discovery/cluster-config/engineering/prod/config.json`

Please follow the following steps to set up a Harness PR pipeline for your ApplicationSet:

1. **Creating Environments**: For this PR Pipeline, we'll create two Harness environments, dev and prod. These names are the same as the folder names in the repo. We use the same names so that when we select a Harness environment we can pass along the same name as the target folder.

	![](static/harness-git-ops-application-set-tutorial-44.png)

2. **Link your GitOps Clusters to the Environment**: Once you have created the environments, you will need to link the GitOps Clusters where your application is deployed to the respective environments.

3. **Creating a Service**: Create a Harness service that points to the `config.json` files in these directories. 

   The path to the config.json files in the service will use the expression `<+env.name>`

	```
	examples/git-generator-files-discovery/cluster-config/engineering/<+env.name>/config.json
	```

    At runtime, this expression resolves to the Harness environment you selected.

	When you run the pipeline, you'll select which environment to use, dev or prod, and Harness will use the corresponding repo folder and update that application only.

4. **Creating a Pipeline**: Create the Harness PR pipeline by following these steps-
   1. In your Harness project, click **Pipelines**.
   2. Click **Create a Pipeline**.
   3. In **Create new Pipeline**, enter the name **PR Pipeline**, and then click **Start**.
   4. Click **Add Stage**, and select **Deploy**.
   
      ![](static/harness-git-ops-application-set-tutorial-50.png)

   5. Enter the following and click **Set Up Stage**:
       1. **Stage Name:** enter **PR Example**.
       2. **Deployment Type:** select **Kubernetes**.
       3. Enable the **GitOps** option.
  
  	![](static/harness-git-ops-application-set-tutorial-51.png)

    The stage is created and the service settings appear.

5. **Add GitOps pipeline steps**:

## Run and verify the PR pipeline

Now your PR pipeline is ready.

1. Click **Save**, and then click **Run**.
2. In **Run Pipeline**, in **Specify Environment**, select the **dev** Environment.
3. In **Environment Variables**, for **asset\_id**, enter the value `12345678`.
4. In **Specify GitOps Clusters**, select the **engineeringdev** cluster.
   
   ![](static/harness-git-ops-application-set-tutorial-57.png)

5. Click **Run Pipeline**.

  You can review the deployment steps in real-time.

  ![](static/harness-git-ops-application-set-tutorial-58.png)
  
  
6. Check the repo to see that the config.json file for the dev environment has been updated with the new **asset\_id** value:

  ![](static/harness-git-ops-application-set-tutorial-60.png)

Congratulations! Your PR Pipeline was successful.

